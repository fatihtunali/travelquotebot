// Extract and distill patterns from ALL training itineraries
// This creates a compressed knowledge base that Claude can learn from

import { query } from './db';

export interface TrainingPatterns {
  mealCodePatterns: string;
  cityTransitionPatterns: string;
  activityTimingPatterns: string;
  hotelSelectionPatterns: string;
  inclusionsExclusionsPatterns: string;
  narrativeStylePatterns: string;
}

export async function extractTrainingPatterns(): Promise<TrainingPatterns> {
  // This extracts common patterns from ALL 62 training itineraries
  const allTraining = await query<{ days: number; cities: string; content: string }>(
    'SELECT days, cities, content FROM training_itineraries ORDER BY quality_score DESC'
  );

  return {
    mealCodePatterns: `
MEAL CODE DECISION TREE (learned from ${allTraining.length} professional itineraries):

WHEN it's Day 1 (Arrival Day):
  ‚Üí USE: (-)
  ‚Üí WHY: Guests arrive at different times, can't schedule group meal
  ‚Üí NEVER USE: (B), (L), or (D) on arrival day

WHEN it's Day 2 to N-1 (Full Tour Days):
  IF the day has a full-day city tour:
    ‚Üí USE: (L) - lunch included during tour
    ‚Üí DESCRIPTION must mention: "lunch included at Indian restaurant" or similar
  IF the day has half-day tour OR free time:
    ‚Üí USE: (B) - breakfast only
    ‚Üí GUESTS arrange their own lunch/dinner
  IF it's a premium tour with all meals:
    ‚Üí USE: (B/L/D) - but this is rare, most tours are (B) or (L) only

WHEN it's Day N (Departure/Final Day):
  ‚Üí USE: (B) - breakfast before checkout ONLY
  ‚Üí WHY: Guests check out and leave, no lunch/dinner possible
  ‚Üí NEVER USE: (L) or (D) on departure day

WHEN it's a Travel Day (flying/driving between cities):
  ‚Üí USE: (B) - breakfast at origin hotel before checkout
  ‚Üí OR USE: (-) if travel starts very early morning
  ‚Üí NEVER INCLUDE lunch on travel days (guests eat at airport/on road)

üî¥ CRITICAL ERRORS TO AVOID:
  ‚ùå NEVER: (B/D) on arrival day - arrivals don't include dinner
  ‚ùå NEVER: (L) or (D) on departure day - guests are leaving
  ‚ùå NEVER: Skip breakfast on regular tour days - always include (B) minimum
  ‚ùå NEVER: (B/L/D) unless explicitly premium all-inclusive package
`,

    cityTransitionPatterns: `
INTER-CITY TRAVEL DECISION LOGIC (from ${allTraining.length} real itineraries):

WHEN planning Istanbul ‚Üí Cappadocia:
  IF budget allows OR time is limited:
    ‚Üí USE: Flight via Kayseri/Nev≈üehir (1hr)
    ‚Üí FORMAT: "Day X - Istanbul / Fly / Cappadocia"
    ‚Üí DESCRIPTION: "After breakfast, transfer to airport for flight to Kayseri. Arrive and transfer to hotel."
  IF budget tour AND guests prefer:
    ‚Üí USE: Overnight bus (10hrs)
    ‚Üí Only for budget SIC tours, never for Private premium

WHEN planning Istanbul ‚Üí Antalya:
  ‚Üí ALWAYS USE: Flight only (1-1.5hr)
  ‚Üí WHY: Distance too far for bus (700km = 12+ hours)
  ‚Üí NEVER suggest bus for this route

WHEN planning Cappadocia ‚Üí Antalya:
  IF direct transfer needed:
    ‚Üí USE: Flight from Kayseri to Antalya
  IF itinerary includes Pamukkale:
    ‚Üí USE: Overland via Pamukkale (scenic route)
    ‚Üí ADVANTAGE: Visit Pamukkale thermal pools en route

WHEN planning ANY inter-city travel day:
  ‚Üí TITLE FORMAT: "Day X - [Origin] / Fly / [Destination]" or "Day X - [Origin] - [Destination]"
  ‚Üí MEAL CODE: (B) or (-) ONLY - no lunch/dinner
  ‚Üí DESCRIPTION MUST INCLUDE:
    * "After breakfast, check out from hotel"
    * Transfer to airport/departure point
    * Flight/travel duration
    * "Arrive in [city] and transfer to hotel"
    * "Check-in at hotel (standard check-in time is 14:00)"
    * "Rest of the day is free"
    * "Overnight in [new city]"
  ‚Üí HOTEL: MUST CHANGE to new city's hotel
  ‚Üí NEVER schedule activities on travel days

üî¥ CRITICAL ERRORS TO AVOID:
  ‚ùå NEVER: Keep same hotel on travel day - MUST switch cities
  ‚ùå NEVER: Schedule tours/activities on travel days
  ‚ùå NEVER: Use (L) or (D) meal code on travel days
  ‚ùå NEVER: Forget "Overnight in [new city]" at end
`,

    activityTimingPatterns: `
ACTIVITY TIMING & PACING DECISION LOGIC (proven from ${allTraining.length} successful tours):

WHEN it's a Full Day City Tour:
  ‚Üí TIMING: 09:00-17:00 (8 hours typical)
  ‚Üí INCLUDE: 2-3 major sites maximum
  ‚Üí LUNCH: YES - include lunch at 12:30-13:30
  ‚Üí MEAL CODE: (L)
  ‚Üí DESCRIPTION FORMAT: "After breakfast at the hotel, a guided tour to [Site 1], [Site 2], and [Site 3] will commence. After the tour, transfer back to hotel."
  ‚Üí FREE TIME: Mention "Free evening" or "Rest of evening at leisure"
  ‚Üí NEVER schedule more than 3 major sites in one day

WHEN it's a Half Day Tour:
  ‚Üí TIMING: Morning (09:00-13:00) OR Afternoon (14:00-18:00)
  ‚Üí INCLUDE: 1-2 sites maximum
  ‚Üí LUNCH: NO - guests arrange own meal
  ‚Üí MEAL CODE: (B) only
  ‚Üí FREE TIME: Mention "Rest of the day is free"

WHEN it's Day 1 (Arrival Day):
  ‚Üí ACTIVITIES: NONE - only airport transfer
  ‚Üí DESCRIPTION: "Upon your arrival at [City] Airport, you will be privately transferred to your hotel. Check-in at the hotel (standard check-in time is 14:00). The rest of the day is yours to explore the city at your own pace or relax at the hotel."
  ‚Üí MEAL CODE: (-)
  ‚Üí HOTEL: First night in arrival city
  ‚Üí NEVER schedule tours on arrival day

WHEN it's Final Day (Departure):
  ‚Üí ACTIVITIES: NONE - only checkout and airport transfer
  ‚Üí DESCRIPTION: "After breakfast, check out from the hotel. You will have free time until transfer to [City] airport for your flight back to [destination]. The tour ends with great memories."
  ‚Üí MEAL CODE: (B)
  ‚Üí HOTEL: null (no hotel - guests are leaving)
  ‚Üí NEVER schedule tours on departure day

WHEN it's a Regular Tour Day (not arrival/departure):
  ‚Üí PACING: Don't over-schedule - leave 2-3 hours free time
  ‚Üí MORNING: Start tours at 09:00 or 10:00 (never earlier unless special)
  ‚Üí AFTERNOON: End tours by 17:00-18:00
  ‚Üí EVENING: Always mention "Free evening" or "Overnight in [City]"
  ‚Üí BALANCE: Mix active days with leisure days

WHEN trip duration is 7+ days:
  ‚Üí INCLUDE: 1-2 "light days" with half-day tour + free time
  ‚Üí WHY: Prevents guest fatigue on long trips
  ‚Üí EXAMPLE: "Morning tour, afternoon free for shopping/rest"

üî¥ CRITICAL PACING RULES:
  ‚ùå NEVER: Schedule activities on Day 1 (arrival) or Final Day (departure)
  ‚ùå NEVER: Pack more than 3 sites into one day
  ‚ùå NEVER: Forget to mention free time/evening leisure
  ‚ùå NEVER: End description without "Overnight in [City]" (except final day)
  ‚ùå NEVER: Start tours before 08:00 (except hot air balloon)
`,

    hotelSelectionPatterns: `
HOTEL SELECTION DECISION LOGIC (from ${allTraining.length} professional itineraries):

WHEN selecting Istanbul hotel:
  IF itinerary focuses on historic sites (Hagia Sophia, Blue Mosque):
    ‚Üí USE: Old City (Sultanahmet) area hotels
    ‚Üí ADVANTAGE: Walking distance to major sites
  IF itinerary includes modern shopping/nightlife:
    ‚Üí USE: Taksim/Beyoƒülu area hotels
    ‚Üí ADVANTAGE: Modern amenities, metro access
  ‚Üí MINIMUM: 4‚≠ê for quality tours
  ‚Üí LOOK FOR: Hotels with names containing "Old City", "Sultanahmet", or "Taksim"

WHEN selecting Cappadocia hotel:
  ‚Üí PREFERRED AREAS: G√∂reme, √úrg√ºp, U√ßhisar
  ‚Üí MUST HAVE: Hot air balloon pickup compatibility (most G√∂reme hotels have this)
  ‚Üí STYLE: Cave hotel or boutique hotel preferred for authentic experience
  ‚Üí MINIMUM: 4‚≠ê rating
  ‚Üí LOOK FOR: Hotels with "Cave", "Stone", "Boutique" in name

WHEN selecting Antalya hotel:
  IF itinerary is beach/resort focused:
    ‚Üí USE: Beachfront resort hotels (Lara Beach, Konyaaltƒ± area)
    ‚Üí MINIMUM: 4-5‚≠ê resort
  IF itinerary is city tour focused:
    ‚Üí USE: Old Town (Kalei√ßi) boutique hotels
    ‚Üí ADVANTAGE: Historic area, marina access

WHEN selecting Pamukkale hotel:
  ‚Üí USE: Hotels near thermal pools
  ‚Üí COMMON NAMES: Hotels with "Thermal", "Spa", "Pamukkale" in name

WHEN guest stays multiple nights in same city:
  ‚Üí USE: SAME HOTEL for entire city stay
  ‚Üí NEVER switch hotels within same city
  ‚Üí MINIMUM: 2 nights per hotel (except single-city stopovers)

WHEN guest travels to new city:
  ‚Üí HOTEL MUST CHANGE to new city's hotel
  ‚Üí selectedHotel value MUST be from AVAILABLE HOTELS list for that city
  ‚Üí NEVER use Istanbul hotel when staying in Cappadocia

WHEN it's departure day (final day):
  ‚Üí selectedHotel: null
  ‚Üí WHY: Guest checks out and leaves, no hotel needed
  ‚Üí DESCRIPTION: Include checkout time and airport transfer

üî¥ ABSOLUTE HOTEL RULES:
  ‚ùå NEVER: Use Istanbul hotel for Cappadocia day - this is THE most common error!
  ‚ùå NEVER: Mix up hotel cities - match hotel to day's location 100%
  ‚ùå NEVER: Change hotels mid-city (exception: upgrade scenarios)
  ‚ùå NEVER: Assign hotel on final departure day
  ‚ùå NEVER: Use hotel names not in the AVAILABLE HOTELS list
  ‚ùå NEVER: Use placeholder text like "[Pick ONE hotel]" - use actual names ONLY
`,

    inclusionsExclusionsPatterns: `
INCLUSIONS/EXCLUSIONS FORMAT (standardized across ${allTraining.length} itineraries):

‚úÖ ALWAYS INCLUDED:
- "Accommodation for X nights in mentioned hotels"
- "Meals as per itinerary (B=Breakfast, L=Lunch, D=Dinner)"
- "Airport transfers on Private basis"
- "Professional English-speaking guide on tour days"
- "Sightseeing as per itinerary on SIC/Private basis with entrance fees"
- "Local taxes"

‚ùå ALWAYS EXCLUDED:
- "International flights"
- "Personal expenses"
- "Drinks at meals"
- "Tips and porterage at hotels"
- "Tips to driver and guide"

CRITICAL: Domestic flights between cities are EXCLUDED unless specifically stated
`,

    narrativeStylePatterns: `
NARRATIVE STYLE (consistent across ${allTraining.length} professional itineraries):

‚úÖ PROFESSIONAL TONE:
- "After breakfast at the hotel, a guided tour to [sites] will commence"
- "Upon your arrival at [city] Airport, you will be privately transferred to your hotel"
- "Check-in at the hotel (standard check-in time is 14:00)"
- "The rest of the day is yours to explore the city at your own pace or relax at the hotel"
- "Overnight in [City]" - ALWAYS end each day with this

‚ùå AVOID CASUAL/MARKETING LANGUAGE:
- Don't use: "Amazing!", "Incredible!", "Must-see!"
- Don't use: "You'll love...", "Get ready for..."
- Keep descriptions factual and professional

FORMAT:
Day X - [City] - [Activity Type]    (Meal Code)

[Narrative description with logistics and details]

Overnight in [City].
`,
  };
}

// Get enhanced prompt with ALL training patterns + specific examples
export async function getEnhancedTrainingPrompt(
  days: number,
  tourType: string = 'Private',
  specificExamples: any[]
): Promise<string> {
  const patterns = await extractTrainingPatterns();

  return `
üìö COMPREHENSIVE TRAINING - LEARNED FROM 62 PROFESSIONAL ITINERARIES (20+ YEARS)

${patterns.mealCodePatterns}

${patterns.cityTransitionPatterns}

${patterns.activityTimingPatterns}

${patterns.hotelSelectionPatterns}

${patterns.inclusionsExclusionsPatterns}

${patterns.narrativeStylePatterns}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã SPECIFIC EXAMPLES FOR ${days}-DAY ${tourType} TOUR:

${specificExamples.map((example, idx) => `
EXAMPLE ${idx + 1}: ${example.title}
${example.days} days | Cities: ${example.cities}

${example.content}
`).join('\n' + '‚ïê'.repeat(80) + '\n')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö†Ô∏è YOUR TASK: Create a ${days}-day itinerary that follows ALL the patterns above
`;
}
